--- 
title: "BSGatlas: Merging"
author:
  - name: Adrian Geissler
    affiliation:
    - &RTH Center for non-coding RNA in Technology and Health,
      Department of Veterinary and Animal Sciences, University of Copenhagen,
      Denmark
  - name: Christian Anthon
    affiliation: *RTH
  - name: Stefan Seemann
    affiliation: *RTH
  - name: Jan Gorodkin
    affiliation:
    - *RTH
    - Corresponding author
date: "`r Sys.time()`"
output:
  BiocStyle::html_document:
    self_contained: TRUE
    toc_float: TRUE
    css: pretty_table.css
---


```{r setup, include = FALSE}
source('00_load.R')


load('02_merging.rda')
load('02_mergign_stat.rda')
```

# Merging

We assigned to each resource a priority, indicating how much we trust these
in comparison to the other available resources.
We compared each pair of genes and overlap, and computed for each overlapping
pair the Jaccard similarity.

The pair of genes from RefSeq and BsubCyc that correspond to each other
according to their loci identifiers are on average highly similar 
(Jaccard > 99%);
only 11 pairs are less simililar that Jaccard < 90%,
and only 5 gene pairs are less similiar than 80%.

For the used resources, we assigned the following confidence levels:

Priority | Resource
---------|-------------------------------------
0        | Coding Genes from RefSeq
1        | Coding Genes from BsubCyc
2        | Non-Coding Genes from RefSeq
2        | Conservative Rfam scan
2        | Genes found in literature review by Nicolas et al
2        | Tiling-array genes identified as trusted by Nicolas et al
3        | Non-Coding Genes from BsubCyc
3        | Riboswitch predictions from term-seq
4        | Rfam scan with medium sensetive parameters
4        | Genes found by the tiling array study 

With respect to all resources,
a histogram of these similarities with clear indication resources priority
the genes in the overlapping pair are is shown in:

```{r}
cowplot::plot_grid(
  cowplot::ggdraw() + cowplot::draw_image('02_level-overlaps.pdf'),
  cowplot::ggdraw() + cowplot::draw_image('02_level-overlaps_high.pdf'),
  labels = c('[0,1]', '[0.8,1]')
)
```

These distirbution shows that nearly all overlaps between coding genes
are either very similiar (Jaccard > 97.8%) or very dissimilar (< 10%).
The ncRNA genes tend to either overlap with a high similarity (> 90%) or
not at all, a pattern persistent across all different level of 
priorities.
There is only a single pair of a low confidence, putative ncRNA and a coding
gene.
Therefore, we assume that two genes with a similarity above 80% are
identical. 
This cut-off is slightly lower than the observed trends, such
that the overall sensetivity is larger and most corresponding pairs of genes
between RefSeq and BsubCyc are included.
Upon closer investigation of the RNA annotation, decided to further relax the
condition to account for the overall lower quality.
Thus, the relaxed identity exludes overlap between
riboswitches and coding sequences, assumes a Jaccard similarity of
at least 80%, or for overlaps between to RNA genes/structures of at
least 50% or the special cased that one annotation is fully contained within
the other. (Containment rule only for RNAs)

with the exception of riboswitches that overlap known coding sequences.
These are kept separate.

We identified all pairs of genes that fullfill this identity criteria.
Using the concept of transitivity, we select groups of genes that are identical
via computation of components in a graph.
For each group, we collect the coordinates from the resource from the highest
priority, or the union if there are multiple genes of equal priority.
The outline for this approach is:

```{r}
cowplot::ggdraw() + cowplot::draw_image('outline_merge.png')
```


Afterwards, we found for each group the most specific type description across
all priorities. In most cases, these are the type which is not putative.
In only few cases we resolved ambiguioty by prefering the type description
asRNA over sRNA, and sRNA over riboswitch.
The latter ambiguoity comes from the term-seq resource, which did not
investigate possible additional biological functions of
partially transcribed RNAs.

For all resources, the merging statistics are
```{r individual}
merging_stat$stat.all %>%
  mutate_all(replace_na, '-') %>%
  kable('latex',
        caption = 'Comparison of the individual resources with the merged result',
        booktabs = TRUE) %>%
  add_indent(c(3, 8, 10:16)) %>%
  row_spec(6, hline_after = TRUE) %>%
  kable_styling(latex_options = 'scale_down') -> tbl_tex

as_image(tbl_tex)

merging_stat$stat.all %>%
  # provide shorter descriptions with linebreaks where needed
  mutate(description = c(
    "Resource Priority",
    "Protein Coding Genes",
    "\\hspace{1em}of these hypothetical",
    "Hypothetical status removed",
    "Coordinates refined",
    "Resource specific genes",
    "Non-Coding RNAs",
    "\\hspace{1em}of these hypothetical",
    "known specific types",
    "\\hspace{1em}ribosomal RNA",
    "\\hspace{1em}transfer RNA",
    "\\hspace{1em}small regulatory RNA",
    "\\hspace{1em}regulatory antisense RNA",
    "\\hspace{1em}riboswitch",
    "\\hspace{1em}self-splicing intron",
    "\\hspace{0.1em}\\specialcell{other\\\\ (ribozyme, SRP, tmRNA)}",
    "Coordinates refined",
    "Hypothetical status remoced",
    "Reclassifed as coding",
    "Resource specific genes"
)) %>% 
  mutate_all(replace_na, '--') %>%
  set_names(c(
    " ",
    "Merged",
    "RefSeq Coding",
    "BsubCyc Coding",
    "RefSeq Non-Coding",
    "\\specialcell{Nicolas \\emph{et al.}'s\\\\ literature review}",
    "\\specialcell{Nicolas \\emph{et al.}\\\\ trusted predictions}",
    "\\specialcell{\\emph{Rfam}\\\\ (conservative)}",
    "BsubCyc Non-Coding",
    "\\specialcell{Dar \\emph{et al.}\\\\ term-seq}",
    "\\specialcell{\\emph{Rfam}\\\\ (medium)}",
    "\\specialcell{Nicolas \\emph{et al.}\\\\ predictions}"
  )) %>%
  kableExtra::kable('latex', booktabs = TRUE,
    caption = 'Comparison of the individual resources with the merged result',
                    linesep = '') %>%
  kable_styling(latex_options = 'scale_down') %>%
  row_spec(6, hline_after = TRUE) %>%
  str_split('\\n') %>%
  unlist %>%
  # thousand digit mark
  str_replace_all('(\\d)(\\d{3})', '\\1,\\2') %>%
  # revert backslash and make curly brackets explicit
  str_replace_all('\\\\[\\{]', '{') %>%
  str_replace_all('\\\\[\\}]', '}') %>%
  str_replace_all('textbackslash\\{\\}', '\\') %>%
  # without environment
  `[`(4:(length(.) - 1)) %>%
  write_lines(path = '02_stat_all.tex')
```



```{r categorized}
merging_stat$categorized.stat %>%
  mutate_all(replace_na, '-') %>%
  kable('latex',
        caption = 'Comparison of the resources with the merged results, aggregated by category. The shown comparison statistics are relative to the gene annotation with the highest priority within each category',
        booktabs = TRUE) %>%
  add_indent(c(2, 7, 9:15)) %>%
  row_spec(5, hline_after = TRUE) %>%
  kable_styling(latex_options = 'scale_down') -> tbl_tex

as_image(tbl_tex)

merging_stat$categorized.stat %>%
  # provide shorter descriptions with linebreaks where needed
  mutate(description = c(
    "Protein Coding Genes",
    "\\hspace{1em}of these hypothetical",
    "Hypothetical status removed",
    "Coordinates refined",
    "Resource specific genes",
    "Non-Coding RNAs",
    "\\hspace{1em}of these hypothetical",
    "known specific types",
    "\\hspace{1em}ribosomal RNA",
    "\\hspace{1em}transfer RNA",
    "\\hspace{1em}small regulatory RNA",
    "\\hspace{1em}regulatory antisense RNA",
    "\\hspace{1em}riboswitch",
    "\\hspace{1em}self-splicing intron",
    "\\hspace{0.1em}\\specialcell{other\\\\ (ribozyme, SRP, tmRNA)}",
    "Coordinates refined",
    "Hypothetical status remoced",
    "Reclassifed as coding",
    "Resource specific genes"
)) %>% 
  mutate_all(replace_na, '--') %>%
  set_names(c(
    " ",
    "Merged",
    "RefSeq",
    "BsubCyc",
    "\\specialcell{Literature\\\\resources}",
    "\\emph{Rfam}",
    "\\specialcell{Nicolas \\emph{et al.}\\\\ predictions}"
  )) %>%
  kableExtra::kable('latex', booktabs = TRUE,
caption = 'Comparison of the resources with the merged results, aggregated by category. The shown comparison statistics are relative to the gene annotation with the highest priority within each category',
                    linesep = '') %>%
  kable_styling(latex_options = 'scale_down') %>%
  row_spec(5, hline_after = TRUE) %>%
  str_split('\\n') %>%
  unlist %>%
  # thousand digit mark
  str_replace_all('(\\d)(\\d{3})', '\\1,\\2') %>%
  # revert backslash and make curly brackets explicit
  str_replace_all('\\\\[\\{]', '{') %>%
  str_replace_all('\\\\[\\}]', '}') %>%
  str_replace_all('textbackslash\\{\\}', '\\') %>%
  # without environment
  `[`(4:(length(.) - 1)) %>%
  write_lines(path = '02_stat_categorized.tex')
```

